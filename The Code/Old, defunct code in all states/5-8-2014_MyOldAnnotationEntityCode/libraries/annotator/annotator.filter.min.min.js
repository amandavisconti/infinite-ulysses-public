!function(){var b=function(d,e){return function(){return d.apply(e,arguments)}},a={}.hasOwnProperty,c=function(g,e){for(var d in e){if(a.call(e,d)){g[d]=e[d]}}function f(){this.constructor=g}f.prototype=e.prototype;g.prototype=new f;g.__super__=e.prototype;return g};Annotator.Plugin.Filter=function(e){c(d,e);d.prototype.events={".annotator-filter-property input focus":"_onFilterFocus",".annotator-filter-property input blur":"_onFilterBlur",".annotator-filter-property input keyup":"_onFilterKeyup",".annotator-filter-previous click":"_onPreviousClick",".annotator-filter-next click":"_onNextClick",".annotator-filter-clear click":"_onClearClick"};d.prototype.classes={active:"annotator-filter-active",hl:{hide:"annotator-hl-filtered",active:"annotator-hl-active"}};d.prototype.html={element:'<div class="annotator-filter">\n  <strong>'+Annotator._t("Navigate:")+'</strong>\n<span class="annotator-filter-navigation">\n  <button class="annotator-filter-previous">'+Annotator._t("Previous")+'</button>\n<button class="annotator-filter-next">'+Annotator._t("Next")+"</button>\n</span>\n<strong>"+Annotator._t("Filter by:")+"</strong>\n</div>",filter:'<span class="annotator-filter-property">\n  <label></label>\n  <input/>\n  <button class="annotator-filter-clear">'+Annotator._t("Clear")+"</button>\n</span>"};d.prototype.options={appendTo:"body",filters:[],addAnnotationFilter:true,isFiltered:function(h,k){var g,j,f,i;if(!(h&&k)){return false}i=h.split(/\s+/);for(j=0,f=i.length;j<f;j++){g=i[j];if(k.indexOf(g)===-1){return false}}return true}};function d(g,f){this._onPreviousClick=b(this._onPreviousClick,this);this._onNextClick=b(this._onNextClick,this);this._onFilterKeyup=b(this._onFilterKeyup,this);this._onFilterBlur=b(this._onFilterBlur,this);this._onFilterFocus=b(this._onFilterFocus,this);this.updateHighlights=b(this.updateHighlights,this);var h;g=$(this.html.element).appendTo((f!=null?f.appendTo:void 0)||this.options.appendTo);d.__super__.constructor.call(this,g,f);(h=this.options).filters||(h.filters=[]);this.filter=$(this.html.filter);this.filters=[];this.current=0}d.prototype.pluginInit=function(){var g,i,f,h;h=this.options.filters;for(i=0,f=h.length;i<f;i++){g=h[i];this.addFilter(g)}this.updateHighlights();this._setupListeners()._insertSpacer();if(this.options.addAnnotationFilter===true){return this.addFilter({label:Annotator._t("Annotation"),property:"text"})}};d.prototype.destroy=function(){var g,f;d.__super__.destroy.apply(this,arguments);f=$("html");g=parseInt(f.css("padding-top"),10)||0;f.css("padding-top",g-this.element.outerHeight());return this.element.remove()};d.prototype._insertSpacer=function(){var g,f;f=$("html");g=parseInt(f.css("padding-top"),10)||0;f.css("padding-top",g+this.element.outerHeight());return this};d.prototype._setupListeners=function(){var h,g,i,f;g=["annotationsLoaded","annotationCreated","annotationUpdated","annotationDeleted"];for(i=0,f=g.length;i<f;i++){h=g[i];this.annotator.subscribe(h,this.updateHighlights)}return this};d.prototype.addFilter=function(g){var i,h;h=$.extend({label:"",property:"",isFiltered:this.options.isFiltered},g);if(!function(){var l,j,k,f;k=this.filters;f=[];for(l=0,j=k.length;l<j;l++){i=k[l];if(i.property===h.property){f.push(i)}}return f}.call(this).length){h.id="annotator-filter-"+h.property;h.annotations=[];h.element=this.filter.clone().appendTo(this.element);h.element.find("label").html(h.label).attr("for",h.id);h.element.find("input").attr({id:h.id,placeholder:Annotator._t("Filter by ")+h.label+"â€¦"});h.element.find("button").hide();h.element.data("filter",h);this.filters.push(h)}return this};d.prototype.updateFilter=function(i){var f,m,h,l,k,g,j;i.annotations=[];this.updateHighlights();this.resetHighlights();h=$.trim(i.element.find("input").val());if(h){m=this.highlights.map(function(){return $(this).data("annotation")});j=$.makeArray(m);for(k=0,g=j.length;k<g;k++){f=j[k];l=f[i.property];if(i.isFiltered(h,l)){i.annotations.push(f)}}return this.filterHighlights()}};d.prototype.updateHighlights=function(){this.highlights=this.annotator.element.find(".annotator-hl:visible");return this.filtered=this.highlights.not(this.classes.hl.hide)};d.prototype.filterHighlights=function(){var f,g,j,m,k,l,o,h,n,i;f=$.grep(this.filters,function(p){return !!p.annotations.length});m=((i=f[0])!=null?i.annotations:void 0)||[];if(f.length>1){j=[];$.each(f,function(){return $.merge(j,this.annotations)});o=[];m=[];$.each(j,function(){if($.inArray(this,o)===-1){return o.push(this)}else{return m.push(this)}})}k=this.highlights;for(l=h=0,n=m.length;h<n;l=++h){g=m[l];k=k.not(g.highlights)}k.addClass(this.classes.hl.hide);this.filtered=this.highlights.not(this.classes.hl.hide);return this};d.prototype.resetHighlights=function(){this.highlights.removeClass(this.classes.hl.hide);this.filtered=this.highlights;return this};d.prototype._onFilterFocus=function(g){var f;f=$(g.target);f.parent().addClass(this.classes.active);return f.next("button").show()};d.prototype._onFilterBlur=function(g){var f;if(!g.target.value){f=$(g.target);f.parent().removeClass(this.classes.active);return f.next("button").hide()}};d.prototype._onFilterKeyup=function(g){var f;f=$(g.target).parent().data("filter");if(f){return this.updateFilter(f)}};d.prototype._findNextHighlight=function(k){var g,h,m,l,j,i,f,n;if(!this.highlights.length){return this}i=k?0:-1;n=k?-1:0;f=k?"lt":"gt";g=this.highlights.not("."+this.classes.hl.hide);m=g.filter("."+this.classes.hl.active);if(!m.length){m=g.eq(i)}h=m.data("annotation");l=g.index(m[0]);j=g.filter(":"+f+"("+l+")").not(h.highlights).eq(n);if(!j.length){j=g.eq(n)}return this._scrollToHighlight(j.data("annotation").highlights)};d.prototype._onNextClick=function(f){return this._findNextHighlight()};d.prototype._onPreviousClick=function(f){return this._findNextHighlight(true)};d.prototype._scrollToHighlight=function(f){f=$(f);this.highlights.removeClass(this.classes.hl.active);f.addClass(this.classes.hl.active);return $("html, body").animate({scrollTop:f.offset().top-(this.element.height()+20)},150)};d.prototype._onClearClick=function(f){return $(f.target).prev("input").val("").keyup().blur()};return d}(Annotator.Plugin)}.call(this);